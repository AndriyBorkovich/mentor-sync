name: Semantic Versioning and Release

on:
    push:
        branches:
            - master
        paths-ignore:
            - "CHANGELOG.md"
            - "scripts/**"
            - "**/*.md"
            - "docs/**"
            - ".github/dependabot.yml"
            - ".github/dependabot/**"

env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    CI_COMMIT_MESSAGE: CI Automatic push on master
    CI_COMMIT_AUTHOR: borkovich25andri@gmail.com

jobs:
    semantic_version:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Perform semantic version
              uses: paulhatch/semantic-version@v5.4.0
              id: semantic_version
              with:
                  tag_prefix: "v"
                  major_pattern: "(MAJOR)"
                  minor_pattern: "(MINOR)"
                  version_format: "${major}.${minor}.${patch}-rc${increment}"
                  user_format_type: "csv"
                  bump_each_commit: false
                  search_commit_body: true

            - name: Bump version and push tag
              id: tag_version
              uses: mathieudutour/github-tag-action@v6.2
              with:
                  custom_tag: ${{ steps.semantic_version.outputs.version_tag }}
                  tag_prefix: ""
                  github_token: ${{ secrets.GITHUB_TOKEN }}

            - name: "Build Changelog"
              id: build_changelog
              uses: mikepenz/release-changelog-builder-action@v6.0.1
              with:
                  fromTag: v${{ steps.semantic_version.outputs.previous_version }}
                  toTag: ${{ steps.tag_version.outputs.new_tag }}

            - name: Create production release
              id: release
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ steps.tag_version.outputs.new_tag }}
                  name: ${{ steps.semantic_version.outputs.version_tag }}
                  body: ${{ steps.build_changelog.outputs.changelog }}
                  draft: false
                  prerelease: false
                  commit: ${{ steps.semantic_version.outputs.current_commit }}

            - name: Update CHANGELOG and push
              run: |
                  set -e
                  git config --global user.name "${{ env.CI_COMMIT_AUTHOR }}"
                  git config --global user.email "${{ env.CI_COMMIT_AUTHOR }}"
                  changelog='${{ steps.build_changelog.outputs.changelog }}'

                  # If no changelog content was generated, skip updating file
                  if [ -z "$changelog" ]; then
                    echo "No changelog content generated; skipping CHANGELOG.md update."
                    exit 0
                  fi

                  # Ensure CHANGELOG.md exists
                  if [ ! -f CHANGELOG.md ]; then
                    echo "# Changelog" > CHANGELOG.md
                    echo "" >> CHANGELOG.md
                  fi

                  # Prepend new entry (safe, without complex escaping)
                  {
                      echo "## ${{ steps.semantic_version.outputs.version_tag }} - $(date +'%Y-%m-%d')"
                      echo ""
                      echo "$changelog"
                      echo ""
                      cat CHANGELOG.md
                  } > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

                  # Only commit if there are changes
                  if git diff --quiet; then
                      echo "No changes to commit; working tree clean."
                      exit 0
                  fi
                  git add CHANGELOG.md
                  git commit -m "chore(docs): update CHANGELOG.md" || true
                  git push origin master
